<div class="calendario-page-container">
  <h1 class="page-title">Calendario</h1>

  <div class="calendario-layout">

    <div class="calendar-container">
      <div class="calendar-header">
        <button (click)="cambiarMes(-1)" class="nav-arrow">&lt;</button>
        <span class="mes-anio">{{ getMesAnio() | titlecase }}</span>
        <button (click)="cambiarMes(1)" class="nav-arrow" [disabled]="esMesFuturoLejano()">
          &gt;
        </button>
      </div>

      <div class="dias-semana-grid">
        @for (dia of nombresDias; track dia) {
          <div class="dia-semana-header">{{ dia.substring(0, 3) }}</div>
        }
      </div>

      <div class="dias-mes-grid">
        @for (dia of diasDelMes; track dia.fecha) {
          <div
            class="dia-celda"
            [class.no-mes-actual]="!dia.esMesActual"
            [class.dia-hoy]="dia.esHoy"
            [class.dia-pasado]="dia.esPasado && dia.esMesActual"
            [class.dia-seleccionado]="dia.fecha === diaSeleccionado?.fecha"
            (click)="seleccionarDia(dia)">
            <span class="numero-dia">{{ dia.numero }}</span>
            @if (dia.disponibilidades.length > 0 && dia.esMesActual && !dia.esPasado) {
              <div class="disponibilidad-dot"></div>
            }
          </div>
        }
      </div>
    </div>

    <div class="sidebar-container">
      <h2 class="sidebar-title">Día y horarios seleccionados</h2>

      @if (diaSeleccionado && diaSeleccionado.esPasado) {
        <p class="error-message">No se pueden gestionar horarios en fechas pasadas.</p>
      }

      <div class="horarios-lista">
        @if (!diaSeleccionado) {
          <p class="horario-placeholder">-- Seleccione un día --</p>
        } @else if (horariosDelDiaSeleccionado.length === 0) {
          <p class="horario-placeholder">-- No hay horarios registrados --</p>
        } @else {
          @for (horario of horariosDelDiaSeleccionado; track horario.idDisponibilidad) {
            <div
              class="horario-item"
              [class.horario-seleccionado]="horario.idDisponibilidad === horarioSeleccionado?.idDisponibilidad"
              (click)="seleccionarHorario(horario)">
              {{ formatoHoraAmPm(horario.horaInicio) }} - {{ formatoHoraAmPm(horario.horaFin) }}
            </div>
          }
        }
      </div>

      <div class="sidebar-actions">
        <button
          class="btn btn-primary"
          (click)="abrirModalRegistrar()"
          [disabled]="!diaSeleccionado || diaSeleccionado.esPasado">
          Registrar
        </button>
        <button
          class="btn btn-secondary"
          (click)="abrirModalEditar()"
          [disabled]="!horarioSeleccionado || diaSeleccionado?.esPasado">
          Editar
        </button>
        <button
          class="btn btn-danger"
          (click)="eliminarDisponibilidad()"
          [disabled]="!horarioSeleccionado || diaSeleccionado?.esPasado">
          Eliminar
        </button>
      </div>
    </div>

  </div>

  @if (showModalRegistrar) {
    <div class="modal-overlay" (click)="showModalRegistrar = false">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3 class="modal-title">Registrar disponibilidad</h3>
        <p>Selecciona el nuevo horario para el <strong>{{ diaSeleccionado?.fecha | date:'d/MM/yyyy' }}</strong></p>

        @if (esHorarioFormularioPasado()) {
          <p class="error-message">¡Advertencia! Este horario de fin ya ha pasado para la fecha seleccionada.</p>
        }

        @if (errorSolapamiento) {
          <p class="error-message">¡Error! Ya existe un registro en este rango de horas.</p>
        }

        <div class="form-group">
          <label for="horario-registrar">Selecciona nuevo horario</label>
          <select id="horario-registrar"
                  [(ngModel)]="horarioFormulario"
                  [compareWith]="compararHorarios"
                  (change)="errorSolapamiento = false">
            @for (slot of horariosPredefinidos; track slot.inicio) {
              <option [ngValue]="{ inicio: slot.inicio, fin: slot.fin }">{{ slot.texto }}</option>
            }
          </select>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" (click)="showModalRegistrar = false">Cancelar</button>
          <button
            class="btn btn-primary"
            (click)="registrarDisponibilidad()"
            [disabled]="esHorarioFormularioPasado()"> Registrar
          </button>
        </div>
      </div>
    </div>
  }

  @if (showModalEditar) {
    <div class="modal-overlay" (click)="showModalEditar = false">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3 class="modal-title">Editar disponibilidad</h3>
        <p>Editando horario del <strong>{{ horarioSeleccionado?.fecha | date:'d/MM/yyyy' }}</strong></p>

        @if (esHorarioFormularioPasado()) {
          <p class="error-message">¡Advertencia! Este horario de fin ya ha pasado para la fecha seleccionada.</p>
        }

        @if (errorSolapamiento) {
          <p class="error-message">¡Error! El nuevo horario choca con otro existente.</p>
        }

        <div class="form-group">
          <label for="horario-editar">Selecciona nuevo horario</label>
          <select id="horario-editar"
                  [(ngModel)]="horarioFormulario"
                  [compareWith]="compararHorarios"
                  (change)="errorSolapamiento = false">
            @for (slot of horariosPredefinidos; track slot.inicio) {
              <option [ngValue]="{ inicio: slot.inicio, fin: slot.fin }">{{ slot.texto }}</option>
            }
          </select>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" (click)="showModalEditar = false">Cancelar</button>
          <button
            class="btn btn-primary"
            (click)="actualizarDisponibilidad()"
            [disabled]="esHorarioFormularioPasado()"> Editar
          </button>
        </div>
      </div>
    </div>
  }
</div>
