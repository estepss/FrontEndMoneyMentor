<div class="asesor-page-container" >
  <h1 class="page-title" >Lista de asesores</h1>

  <div class="asesores-grid">

    @if (asesores.length === 0) {
      <p class="empty-state">No hay asesores registrados actualmente.</p>
    }

    @for (asesor of asesores; track asesor.idAsesor) {
      <div class="asesor-card">

        <div class="card-header">
          <div class="header-name-box">{{ asesor.nombre }}</div>

          <div class="profile-photo">
            <img
              [src]="getPlaceholderAvatar(asesor.nombre)"
              [alt]="'Foto de ' + asesor.nombre"
            />
          </div>
        </div>

        <div class="card-body">

          <p class="content-text">
            {{ asesor.sobreMi || 'Este asesor aún no ha añadido una descripción.' }}
          </p>

          <div class="card-actions">
            <button
              class="action-button btn-revisar"
              (click)="abrirModalResena(asesor)">
              Revisar
              <span class="material-icons-sharp">rate_review</span>
            </button>

            <button
              class="action-button btn-reservar"
              (click)="abrirReserva(asesor)">
              Reservar
              <span class="material-icons-sharp">event_available</span>
            </button>
          </div>
        </div>

      </div>
    }

    <!-- BOTÓN MIS RESERVAS -->
    <div class="reservas-button-container">
      <button class="btn-reservas" (click)="abrirModalReservas()">
        Mis Reservas
        <span class="material-icons-sharp">event_note</span>
      </button>
    </div>

  </div>
</div>


<!-- ===================== MODAL RESEÑAS ===================== -->
@if (mostrarResenaModal && asesorSeleccionado) {
  <div class="modal-overlay" (click)="cerrarModalResena()">
    <div class="modal-content resena-modal" (click)="$event.stopPropagation()">

      <button class="cerrar-modal" (click)="cerrarModalResena()">×</button>

      <div class="modal-header-info">

        <div class="modal-avatar">
          {{ getIniciales(asesorSeleccionado.nombre) }}
        </div>

        <div class="modal-name-block">
          <h3 class="modal-name">{{ asesorSeleccionado.nombre }}</h3>

          <div class="modal-experience">
            {{
              asesorSeleccionado.sobreMi
              || 'Este asesor aún no ha añadido una descripción personal.'
            }}
          </div>
        </div>
      </div>

      <!-- FORM RESEÑA -->
      <form [formGroup]="resenaForm" class="form-reseña" (click)="$event.stopPropagation()">

        <input
          type="number"
          min="1"
          max="5"
          placeholder="Calificación (1 a 5)"
          formControlName="puntuacion"
        />

        <textarea
          placeholder="Escribir un comentario"
          formControlName="comentario">
        </textarea>

        <button class="btn-enviar" type="button" (click)="enviarResena()" [disabled]="resenaForm.invalid">
          Enviar
        </button>
      </form>

      <!-- LISTA RESEÑAS -->
      <div class="reseñas-previas">

        @if (resenas[asesorSeleccionado.idAsesor]?.length === 0) {
          <p class="no-reseñas">Este asesor aún no tiene reseñas.</p>
        } @else {
          @for (r of resenas[asesorSeleccionado.idAsesor]; track r.idCalificacion) {

            <div class="reseña-item">
              <div class="avatar-mini">
                {{ getIniciales(r.nombreCliente || 'C') }}
              </div>

              <div class="reseña-info">

                <div class="fila-nombre">
                  <strong>{{ r.nombreCliente || 'Cliente' }}</strong>
                  <span class="estrellas">{{ '★'.repeat(r.puntuacion) }}</span>
                </div>

                <p>{{ r.comentario }}</p>

              </div>
            </div>
          }
        }
      </div>

    </div>
  </div>
}


<!-- ===================== MODAL RESERVA ===================== -->
@if (mostrarReservaModal && asesorReserva) {
  <div class="modal-overlay" (click)="cerrarReservaModal()">
    <div class="modal-content reserva-modal" (click)="$event.stopPropagation()">

      <h3 class="modal-title">Reservar cita con {{ asesorReserva.nombre }}</h3>

      <p class="texto-horario">Selecciona un horario disponible:</p>

      <div class="horarios-disponibles-lista">

        @if (horariosVisibles.length === 0) {
          <p class="horario-placeholder">No hay horarios disponibles.</p>
        } @else {

          @for (slot of horariosVisibles; track slot.idDisponibilidad) {
            <div
              class="slot-item"
              [class.slot-seleccionado]="slot.idDisponibilidad === slotSeleccionado?.idDisponibilidad"
              (click)="seleccionarSlot(slot)"
            >
              <span class="slot-fecha">{{ slot.fecha | date:"EEEE d 'de' MMMM" | titlecase }}</span>
              <span class="slot-hora">
                {{ formatoHoraAmPm(slot.horaInicio) }} - {{ formatoHoraAmPm(slot.horaFin) }}
              </span>
            </div>
          }
        }

      </div>


      <form [formGroup]="reservaForm" class="form-group" (click)="$event.stopPropagation()">
        <label>Tarjeta de pago</label>
        <select formControlName="tarjeta">
          @for (t of tarjetas; track t.idTarjeta) {
            <option [ngValue]="t">
              {{ t.nombreTarjeta }} - **** {{ t.numeroTarjeta.slice(-4) }}
            </option>
          }
          <option *ngIf="tarjetas.length === 0" disabled>No tienes tarjetas registradas</option>
        </select>
      </form>

      <!-- MONTO FINAL -->
      <p class="monto-final">
        Monto total: <strong>{{ precioCalculado }} soles</strong>
      </p>

      <div class="modal-actions">
        <button class="btn btn-secondary" (click)="cerrarReservaModal()">Cancelar</button>

        <button class="btn btn-primary"
                (click)="confirmarReserva()"
                [disabled]="!slotSeleccionado || reservaForm.invalid">
          Confirmar Reserva
        </button>
      </div>

    </div>
  </div>
}


<!-- ===================== MIS RESERVAS ===================== -->
@if (mostrarModalReservas) {
  <div class="modal-overlay" (click)="cerrarModalReservas()">
    <div class="reservas-modal" (click)="$event.stopPropagation()">

      <button class="cerrar-modal" (click)="cerrarModalReservas()">×</button>

      <h2 class="reservas-title">Mis reservas</h2>

      @if (reservasCliente.length === 0) {
        <p class="text-center sin-reservas">No tienes reservas pendientes.</p>
      } @else {

        <div class="reservas-grid">

          @for (res of reservasCliente; track res.idReserva) {
            <div class="reserva-card">

              <div class="reserva-header">
                <div class="reserva-avatar">
                  {{ getIniciales(res.asesor.nombre) }}
                </div>

                <div class="reserva-info">
                  <h3>{{ res.asesor.nombre }}</h3>
                  <p class="descripcion">{{ res.asesor.sobreMi }}</p>
                </div>
              </div>

              <div class="reserva-fechas">
                <p><strong>Fecha:</strong> {{ res.fechaHoraInicio | date:'EEEE d MMMM yyyy' }}</p>
                <p><strong>Hora:</strong>
                  {{ res.fechaHoraInicio | date:'shortTime' }}
                  -
                  {{ res.fechaHoraFin | date:'shortTime' }}
                </p>
              </div>

              <div class="reserva-actions">
                <button class="btn-reprogramar" (click)="abrirReprogramar(res)">Reprogramar</button>
                <button class="btn-eliminar" (click)="eliminarReserva(res)">Eliminar</button>
              </div>

            </div>
          }

        </div>

      }

    </div>
  </div>
}


<!-- ===================== REPROGRAMAR ===================== -->
@if (mostrarModalReprogramar && reservaAReprogramar) {
  <div class="modal-overlay" (click)="cerrarReprogramar()">
    <div class="reprogramar-modal" (click)="$event.stopPropagation()">

      <button class="cerrar-modal" (click)="cerrarReprogramar()">×</button>

      <h3>Reprogramar cita</h3>

      <form [formGroup]="reprogramForm">
        <label>Seleccione un nuevo horario:</label>
        <select formControlName="nuevoHorario" class="select-horarios">
          @for (disp of horariosDisponiblesReprogramacion; track disp.idDisponibilidad) {
            <option [ngValue]="disp">
              {{ disp.fecha }} | {{ disp.horaInicio }} - {{ disp.horaFin }}
            </option>
          }
        </select>

        <div class="modal-actions">
          <button class="btn-secondary" (click)="cerrarReprogramar()">Cancelar</button>
          <button class="btn-primary" (click)="confirmarReprogramacion()" [disabled]="reprogramForm.invalid">Guardar</button>
        </div>
      </form>

    </div>
  </div>
}
