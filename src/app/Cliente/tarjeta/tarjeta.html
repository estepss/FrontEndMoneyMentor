<div class="tarjeta-page-container">

  <h1 class="page-title">
    @if (vistaActual === 'agregar') {
      Tarjeta
    } @else {
      Lista de Tarjeta
    }
  </h1>

  <!-- VISTA: AGREGAR TARJETA (FORMULARIO REACTIVO) -->
  @if (vistaActual === 'agregar') {
    <div class="card-form-container">
      <div class="form-header" style="background-color: #935B44;">
        Ingresar una tarjeta
      </div>

      <!-- Vinculamos el FormGroup aquí -->
      <form [formGroup]="tarjetaForm" class="form-body">

        <!-- Campo Nombre -->
        <div class="input-group">
          <label for="nombre">Nombre</label>
          <input
            id="nombre"
            type="text"
            formControlName="nombreTarjeta"
            placeholder="Nombre en la tarjeta"
            [class.is-invalid]="f['nombreTarjeta'].invalid && f['nombreTarjeta'].touched"
          />
          <!-- Mensaje de error opcional en HTML -->
          @if (f['nombreTarjeta'].invalid && f['nombreTarjeta'].touched) {
            <div class="error-text">El nombre es obligatorio.</div>
          }
        </div>

        <!-- Campo Número de Tarjeta -->
        <div class="input-group">
          <label for="numero">Número de Tarjeta</label>
          <input
            id="numero"
            type="text"
            formControlName="numeroTarjeta"
            placeholder="XXXX XXXX XXXX XXXX"
            [class.is-invalid]="f['numeroTarjeta'].invalid && f['numeroTarjeta'].touched"
          />
          @if (f['numeroTarjeta'].hasError('pattern') && f['numeroTarjeta'].touched) {
            <div class="error-text">Debe tener entre 13 y 19 dígitos numéricos.</div>
          }
        </div>

        <!-- Campos Fecha y CVC -->
        <div class="input-group-inline">

          <div class="inline-section expiration-date">
            <label>Fecha de expiración</label>
            <div class="inline-fields">
              <select formControlName="mesExpiracion">
                @for (mes of meses; track mes) {
                  <option [value]="mes">{{ getNombreMes(mes) }}</option>
                }
              </select>
              <select formControlName="anioExpiracion">
                @for (anio of anios; track anio) {
                  <option [value]="anio">{{ anio }}</option>
                }
              </select>
            </div>
            @if (tarjetaForm.hasError('fechaPasada') && (f['mesExpiracion'].touched || f['anioExpiracion'].touched)) {
              <div class="error-text">Tarjeta caducada.</div>
            }
          </div>

          <div class="inline-section cvc-field">
            <label for="cvc">CVC</label>
            <input
              id="cvc"
              type="text"
              formControlName="cvc"
              placeholder="XXX"
              [class.is-invalid]="f['cvc'].invalid && f['cvc'].touched"
            />
            @if (f['cvc'].invalid && f['cvc'].touched) {
              <div class="error-text">3 o 4 dígitos.</div>
            }
          </div>
        </div>

        <!-- Botones de Acción -->
        <div class="form-actions">
          <button
            type="button"
            class="action-button primary"
            (click)="agregarTarjeta()"
            style="background-color: #179BAE;">
            Agregar tarjeta
          </button>

          <button
            type="button"
            class="action-button secondary"
            (click)="mostrarLista()"
            style="background-color: #179BAE;">
            Ver tarjetas agregadas
          </button>
        </div>
      </form>
    </div>
  }

  <!-- VISTA: LISTA DE TARJETAS AGREGADAS (Misma lógica de visualización) -->
  @if (vistaActual === 'lista') {
    <div class="cards-list-container">
      @if (tarjetasAgregadas.length === 0) {
        <div class="empty-state">
          <p>No tienes tarjetas agregadas.
            <a (click)="mostrarAgregar()">Haz clic aquí para agregar una.</a>
          </p>
        </div>
      } @else {
        @for (tarjeta of tarjetasAgregadas; track $index) {
          <div class="list-card-item">
            <div class="delete-button" (click)="eliminarTarjeta($index)">
              <span class="material-icons-sharp">delete</span>
            </div>

            <div class="data-group">
              <span class="label">Nombre</span>
              <span class="value">{{ tarjeta.nombreTarjeta }}</span>
              <hr/>
            </div>

            <div class="data-group">
              <span class="label">Número de Tarjeta</span>
              <span class="value">{{ tarjeta.numeroTarjeta }}</span>
              <hr/>
            </div>

            <div class="data-group-inline">
              <div class="inline-data expiration-info">
                <span class="label">Fecha de expiración</span>
                <span class="value">{{ getNombreMes(tarjeta.mesExpiracion) }} / {{ tarjeta.anioExpiracion }}</span>
              </div>
              <div class="inline-data cvc-info">
                <span class="label">CVC</span>
                <span class="value">{{ tarjeta.cvc }}</span>
              </div>
            </div>
          </div>
        }
      }

      <div class="form-actions list-actions">
        <button
          type="button"
          class="action-button primary"
          (click)="mostrarAgregar()"
          style="background-color: #179BAE;">
          Agregar otra tarjeta
        </button>
      </div>

    </div>
  }
</div>
