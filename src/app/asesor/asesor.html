<div class="asesor-page-container">
  <h1 class="page-title">Lista de asesores</h1>

  <div class="asesores-grid">
    <div class="asesor-card" *ngFor="let asesor of asesores; let i = index">
      <div class="card-header">
        <div class="header-name-box">{{ asesor.nombre }}</div>
        <div class="profile-photo">
          <img
            [src]="asesor.imagenUrl"
            [alt]="'Foto de ' + asesor.nombre"
            (error)="onImageError($event)"
          />
        </div>
      </div>

      <div class="card-body">
        <p class="content-text question-text">
          {{ asesor.textoPrincipal }}
        </p>

        <button class="action-button" (click)="abrirModal(asesor)">
          Revisar
          <span class="material-icons-sharp">rate_review</span>
        </button>
      </div>
    </div>
  </div>

  <!-- BotÃ³n inferior -->
  <div class="reservas-container">
    <button class="reservas-button">Reservas</button>
  </div>
</div>

<!-- MODAL DE RESEÃ‘A -->
<div class="modal-overlay" *ngIf="mostrarModal">
  <div class="modal">
    <button class="cerrar-modal" (click)="cerrarModal()">X</button>

    <div class="modal-header" *ngIf="asesorSeleccionado">
      <div class="avatar-modal">
        {{ getIniciales(asesorSeleccionado.nombre) }}
      </div>
      <div>
        <h3>{{ asesorSeleccionado.nombre }}</h3>
        <p class="descripcion-asesor">
          Hola, soy
          {{
            asesorSeleccionado.nombre
              ? asesorSeleccionado.nombre.split(' ')[0]
              : ''
          }}
          y tengo {{ asesorSeleccionado.experiencia }} aÃ±os de experiencia
        </p>
      </div>
    </div>

    <div class="form-reseÃ±a">
      <input
        type="number"
        placeholder="Da una calificaciÃ³n del 1 al 5"
        [(ngModel)]="nuevaResena.puntuacion"
        min="1"
        max="5"
      />
      <textarea
        placeholder="Escribir un comentario"
        [(ngModel)]="nuevaResena.comentario"
      ></textarea>
      <button class="btn-enviar" (click)="enviarResena()">Enviar</button>
    </div>

    <div class="reseÃ±as-previas" *ngIf="asesorSeleccionado">
      <div
        class="reseÃ±a-item"
        *ngFor="let r of resenas[asesorSeleccionado.id]"
      >
        <div class="avatar-mini">{{ getIniciales(r.cliente) }}</div>
        <div>
          <strong>{{ r.cliente }}</strong>
          <span class="estrellas">{{ 'â˜…'.repeat(r.puntuacion) }}</span>
          <p>{{ r.comentario }}</p>
        </div>
      </div>
    </div>

    <!-- Este botÃ³n abre el calendario/reserva -->
    <button class="btn-reservar" (click)="abrirReserva(asesorSeleccionado)">
      Reservar
    </button>
  </div>
</div>

<!-- MODAL CALENDARIO / RESERVAS -->
<div class="modal-overlay" *ngIf="mostrarReservaModal">
  <div class="modal card-modal">
    <button class="cerrar-modal" (click)="cerrarReservaModal()">X</button>

    <h3 style="color:var(--color-dark-blue); margin-top: 6px;">Calendario</h3>

    <div class="calendar-container">
      <!-- calendario izquierdo -->
      <div class="calendar">
        <div class="month-header">
          <div class="month-nav">
            <button (click)="prevMonth()">&lt;</button>
          </div>
          <div class="month-title">
            {{ monthNames[currentMonth] }} {{ currentYear }}
          </div>
          <div class="month-nav">
            <button (click)="nextMonth()">&gt;</button>
          </div>
        </div>

        <div class="weekdays">
          <div *ngFor="let wd of weekDays">{{ wd }}</div>
        </div>

        <div class="days-grid">
          <div
            *ngFor="let day of calendarDays"
            [class.day]="true"
            [class.inactive]="!day.inCurrentMonth"
            [class.selected]="isSelected(day)"
            [class.today]="isToday(day)"
            (click)="selectDay(day)"
          >
            {{ day.date.getDate() }}
          </div>
        </div>

        <div style="margin-top: 12px; display:flex; gap:8px;">
          <input type="text" [value]="inputMonthYear" readonly style="flex:1; padding:8px; border-radius:8px; border:1px solid #ddd;"/>
          <button class="btn-ghost" (click)="goToToday()">Hoy</button>
        </div>
      </div>

      <!-- panel derecho -->
      <div class="calendar-right">
        <h4>DÃ­a y hora seleccionada</h4>

        <div class="selected-info">
          <div *ngIf="selectedDateStr; else noSelection">
            <div style="font-weight:700; margin-bottom:6px;">-- {{ selectedDateStr }} --</div>
            <div style="color:#777; margin-bottom:8px;">-- {{ asesorReserva?.nombre }} --</div>

            <div *ngIf="availableSlots.length">
              <div *ngFor="let s of availableSlots" class="slot-box">
                <div class="slot-pill">{{ s.label }}</div>
                <div>
                  <button class="btn-primary" (click)="registrarSlot(s)">Registrar</button>
                </div>
              </div>
            </div>

            <div class="reserved-list">
              <div *ngFor="let r of getReservasForAsesor(asesorReserva?.id)" class="reserved-item">
                <div>
                  â€¢ Cita con {{ asesorReserva?.nombre }}<br/>
                  <small>{{ r.fecha }} â€” {{ r.horaInicio }} - {{ r.horaFin }}</small>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="btn-ghost" (click)="openCardModal(r)">+</button>
                  <button class="btn-ghost" (click)="eliminarReserva(asesorReserva?.id, r)">ðŸ—‘</button>
                </div>
              </div>
            </div>

            <div style="margin-top: 12px;">
              <button class="btn-primary" (click)="openCardModal()" [disabled]="!hasAnyReservaForSelectedDate()">Seleccionar tarjeta</button>
            </div>
          </div>

          <ng-template #noSelection>
            <div style="color:#666;">-- Selecciona un dÃ­a a la izquierda --</div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL TARJETA / PAGO -->
<div class="modal-overlay" *ngIf="mostrarCardModal">
  <div class="modal card-modal">
    <button class="cerrar-modal" (click)="cerrarCardModal()">X</button>
    <h4>Seleccionar tarjetas registradas</h4>

    <div style="margin-top:10px;">
      <select style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;" [(ngModel)]="selectedCard">
        <option [ngValue]="null">Seleccione tarjeta...</option>
        <option [value]="'visa-46'">Mi visa que termina en **46</option>
      </select>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button class="btn-primary" (click)="confirmarPago()" [disabled]="!selectedCard">Pagar</button>
      <button class="btn-ghost" (click)="cerrarCardModal()">Cancelar</button>
    </div>
  </div>
</div>
